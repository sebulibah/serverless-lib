# Serverless Books

This project is a simple Books CRUD application implemented to be deployed on AWS Lambda using Serverless framework.

# Using the application

## Installation

To install the application run the following commands:

```
cd backend
npm install
sls deploy -v
```

## Postman collection

Import the Postman collection in the backend/ folder which contains sample requests.

The API endpoints are:
```
POST - https://{{apiId}}.execute-api.us-east-2.amazonaws.com/dev/books
GET - https://{{apiId}}.execute-api.us-east-2.amazonaws.com/dev/books
PATCH - https://{{apiId}}.execute-api.us-east-2.amazonaws.com/dev/books{bookId}
DELETE - https://{{apiId}}.execute-api.us-east-2.amazonaws.com/dev/books{bookId}
POST - https://{{apiId}}.execute-api.us-east-2.amazonaws.com/dev/books{bookId}/attachment
```

The `apiId` is configured as environment variables.
For authentication there is collection is configured OAuth2.0 to generate access tokens.
Example requests are also provided in the collection.

# Functionality of the application

This serverless application allows creating/removing/updating/fetching books. Each BOOK can optionally have an attachment image. Each user only has access to BOOKs that they have created.

## BOOK item

The application stores BOOKs, and each BOOK contains the following fields:

* `userId` (string) - the userId for the user that created the BOOK item
* `bookId` (string) - a unique autogenerated id for a BOOK
* `createdAt` (string) - the date and time when a BOOK was added
* `title` (string) - title of a BOOK
* `dueDate` (string) - the date and time by which an book should be returned
* `completed` (boolean) - the value is true if the BOOK has been completed, defaults to false 
* `attachmentUrl` (string) (optional) - a URL pointing to an image attached to a BOOK


## Functions to be implemented

The following functions are implemented in the `serverless.yml` file:

* `Auth` - verifies the Auth0 JWT tokens passed in the Authorization header to grant access or deny the user access to the lambda functions.

* `GetBooks` - returns all BOOKs for a current user.

The returned data looks like:

```json
{
  "items": [
    {
      "bookId": "046f7daf-6f6e-413a-acf8-7c61c19ba04a",
      "userId": "OLZJf4NjgW46A2uzcBYNEbTqBXgoXikz@clients",
      "createdAt": "2021-04-24T04:16:06.181Z",
      "title": "A Tale of Two Kitties",
      "dueDate": "2019-07-29T20:01:45.424Z",
      "completed": false,
      "attachmentUrl": "https://serverless-booklib-rdstr-dev.s3.amazonaws.com/046f7daf-6f6e-413a-acf8-7c61c19ba04a"
    },
    {
      "bookId": "4cc1f2bd-2fb7-4e50-943e-09b7df3a7245",
      "userId": "OLZJf4NjgW46A2uzcBYNEbTqBXgoXikz@clients",
      "createdAt": "2019-07-27T20:01:45.424Z",
      "title": "Intro to Serverless Framework",
      "dueDate": "2021-04-24T03:52:13.763Z",
      "completed": true,
      "attachmentUrl": "https://serverless-booklib-rdstr-dev.s3.amazonaws.com/4cc1f2bd-2fb7-4e50-943e-09b7df3a7245"
    },
  ]
}
```

* `CreateBook` - this creates a new BOOK for the current user. The shape of data sent by a client application to this function can be found in the `CreateBookRequest.ts` file

It receives a new BOOK item as a JSON object via a POST request with fields:

```json
{
  "title": "Intro to Serverless Framework",
  "dueDate": "2021-04-24T03:52:13.763Z",
  "attachmentUrl": "https://serverless-booklib-rdstr-dev.s3.amazonaws.com/4cc1f2bd-2fb7-4e50-943e-09b7df3a7245"
}
```

The attachmentUrl is optional.
It returns a new BOOK item that looks like:

```json
{
  "item": {
      "bookId": "4cc1f2bd-2fb7-4e50-943e-09b7df3a7245",
      "userId": "OLZJf4NjgW46A2uzcBYNEbTqBXgoXikz@clients",
      "createdAt": "2021-04-24T03:52:13.763Z",
      "title": "Intro to Serverless Framework",
      "dueDate": "2021-04-24T03:52:13.763Z",
      "completed": true,
      "attachmentUrl": "https://serverless-booklib-rdstr-dev.s3.amazonaws.com/4cc1f2bd-2fb7-4e50-943e-09b7df3a7245"
  }
}
```

* `UpdateBook` - this updates a BOOK item created by a user. Pass the `bookId` of the BOOK item to update in the URL. Example `https://{{apiId}}.execute-api.us-east-2.amazonaws.com/dev/books/4cc1f2bd-2fb7-4e50-943e-09b7df3a7245`
The shape of data sent by a client application to this function is found in the `UpdateBookRequest.ts` file

It receives a JSON object that contains three fields that can be updated in a BOOK item:

```json
{
  "title": "Intro to Serverless Framework",
  "dueDate": "2021-04-24T03:52:13.763Z",
  "completed": false
}
```

* `DeleteBook` - should delete a BOOK item created by a current user. Pass the `bookId` of a BOOK item to remove.
Example: `https://{{apiId}}.execute-api.us-east-2.amazonaws.com/dev/books/4cc1f2bd-2fb7-4e50-943e-09b7df3a7245`  

* `GenerateUploadUrl` - returns a pre-signed URL that can be used to upload an attachment file for a book item. Pass the `bookId` in the endpoint url.
Example: `https://{{apiId}}.execute-api.us-east-2.amazonaws.com/dev/books/4cc1f2bd-2fb7-4e50-943e-09b7df3a7245/attachment`

It should return a JSON object that looks like:

```json
{
    "uploadUrl": "https://serverless-booklib-rdstr-dev.s3.us-east-2.amazonaws.com/4cc1f2bd-2fb7-4e50-943e-09b7df3a7245?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIA6QTGDNLVDRVJ2OXG%2F20210425%2Fus-east-2%2Fs3%2Faws4_request&X-Amz-Date=20210425T125711Z&X-Amz-Expires=300&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJ3%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaCXVzLWVhc3QtMiJHMEUCIG7hdhUnLAjuQhHMOSIwrzwieVwhKXSv3iEhjAWviV0ZAiEAsKIk0KxHAtImWapLCqyjdEtg5Tw744L1FPuk%2F6rOJG8q4wEIFhABGgw5OTc3MjAyODc5NzgiDJ82bqW0alE4AKBThirAAasp45ip6WuTRzZgnziaOFa1QrTngCEsafXnzgUGXsC%2BG8zETAipjsvmWcfWdq6kThXc76sf%2FEjHD8qVWyAYKguwS%2BUJXdno35ZoBGQgX8nhUo8hhBDEM2iua2LUqW98%2FSdiQXzvxrgmgthluUZVItapaq2Y%2FMZeoUHqGkU4TEqIoE2hXy2IKjBmJNl%2FFOO5sdlKDLsRkqqtB3%2FRU%2BGWAqRmwIpH0alU0y5qDhjA9FM6oagbbZbtbQIe%2BzDtpP9bdTCmzpWEBjrgAcJuvWNo5Mbz0QgDRueJWZKT8AVIW4FwgBQbOZkFMNoddq0hoqlPx90IZlu0KBCowvcOQ1P5kGjnz8Rf2KRZbMqJ1lqq4XOBQTsRLztlfcS77XlANJZh03mRu6PO42mPIpPJkMSEUz7%2FKcC%2F8abciFOb8X0qa4afhGcIblhT2Kfm2G9hltbacHZPZ1RKuJ2c16rwcSPLn%2Br9xt3bWHS%2B%2Bt0l22FC%2BjBxtrh0GpFANs22LdFY1EjmF%2Bp6VhLiWiZ2NRwdckDlOJE4CJrdOKgHW1jIO39nzIVSVQ9%2FloBUNKUh&X-Amz-Signature=462af0f3e35ba23ea9b3e91c4cbdd11d73f3ce70767533ab080802e2e8b99b4e&X-Amz-SignedHeaders=host"
}
```

To upload an image to the Attachments S3 bucket
* click the upload URL and a new request will be created.
* Select `PUT` as the HTTP method. 
* In the body type select `binary`, `Select File`, choose the image to upload and send the request.
The response should contain the status code 200.

To view the image, select the  `attachementUrl` (for the item in GetBook items) and send a GET request.


## Authentication

To gain authorized access to the CRUD Lambda API functions a user needs to register to use Serverless Lib by requesting a new access token. The `auth0Authorizer` lambda will verify that the token was issued by the Serverless lib and grant or revoke user access.

To generate an access token follow the following procedure in Postman.

1. The Postman collection is configured to generate a new access token from the Auth0 application under the Authorization tab.
1. To sign up as a new user scroll to the bottom of the page and `Clear cookies` and Select `Get New Access Token`.
1. After signing up and granting Serverless Lib access, allow pop-ups from `pstmn.io` for the access token be returned to Postman.
1. Select `Use token`.
1. When interacting with the individual requests, in the Authorizationthe Type should be set to `Inherit from parent`


# Code Base

* The application Business Logic and Data Layer are separated
* The code has been implemented with Async/ Await

# Best Practices

* The resources necessary for the application are defined in the `serverless.yml`.
* Each function has its own IAM roles attached.
* The application has sufficient monitoring with configured [Winston](https://github.com/winstonjs/winston) logger.
* The HTTP requests are validated

# Architecture

* The data is stored in a table with a composite key.
* The scan operation is not used to read data from a database.
